#!/bin/bash

# Builds site for a particular version
version="$1"
branch="gh-pages"
repository="git@github.com:darylteo/edge-site.git"

compiledDir="gh-pages/$version"
environmentFile="versions/$version/_prod.yml"
configFile="versions/$version/_config.yml"

if [ -z "$version" ]
then
	echo "Please specify version"
	exit 1
else
	echo "Building version $version"
fi

# check if version exists
if [ ! -d "versions/$version" ]
then
	echo "Version does not exist -> versions/$version"
	exit 2
fi

# clone gh-pages if it does not exist
if [ ! -d "gh-pages" ]
then
	git clone -b "$branch" "$repository" gh-pages;
fi

# perform jekyll compilation
mkdir $compiledDir
cp "$environmentFile" "$configFile"
jekyll "versions/$version/" "$compiledDir" --no-server --no-auto > /dev/null 2>&1;

# Publishes gh-pages
if [ -d "gh-pages" ]
then
	echo "Changing to gh-pages directory"
	pushd gh-pages;

	echo "Pushing to gh-pages"
	git add .;
	git commit -a;

	if [ "$?" == 1 ]
	then
		exit 1
	fi

	git push origin gh-pages;

	echo "Done";
	popd;
fi

rm $configFile
